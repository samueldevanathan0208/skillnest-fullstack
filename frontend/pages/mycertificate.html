<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Certificates | SkillNest</title>

    <link rel="stylesheet" href="../css/mycertificate.css?v=2">

    <link rel="stylesheet" href="../css/dashboard.css">
    <link rel="stylesheet" href="../css/mylearn.css">
    <link rel="stylesheet" href="../css/modals.css">

    <script src="../js/sidebar-handlers.js" defer></script>
</head>

<body>

    <!-- Sidebar -->
    <aside class="sidebar">
        <nav>
            <div class="nav-section">
                <img class="logo" src="../assests/Gemini_Generated_Image_awja8lawja8lawja-removebg-preview.png"
                    alt="Logo">
                <a href="dashboard.html" class="nav-item">Dashboard</a>
                <a href="mylearn.html" class="nav-item">My Learning</a>
                <a href="mycertificate.html" class="nav-item active">Certificate</a>
            </div>

            <div class="nav-section">
                <h3 class="nav-section-title">Learn</h3>
                <a href="learingpath.html" class="nav-item">Learning Path</a>
                <a href="quizzes.html" class="nav-item">Quizzes</a>
            </div>

            <div class="nav-section">
                <h3 class="nav-section-title">Account Setting</h3>
                <a href="edit.html" class="nav-item">Edit Profile</a>
                <a href="#" id="delete-profile-link" class="nav-item">Delete Profile</a>
                <a href="#" id="sign-out-link" class="nav-item">Sign Out</a>
            </div>
        </nav>
    </aside>

    <!-- Main -->
    <div class="main-wrapper">
        <div class="header">
            <h1>My Certificates</h1>
            <p>Download your earned certificates</p>
        </div>

        <div class="container">
            <div id="loading" style="text-align:center;padding:2rem;">
                Loading certificates...
            </div>

            <div id="empty" style="display:none;text-align:center;padding:2rem;">
                <h2>No Certificates Yet</h2>
                <p>Complete all videos and quizzes to unlock certificates.</p>
                <a href="mylearn.html">Go to My Learning</a>
            </div>

            <div id="certificates" class="certificates-grid"></div>
        </div>
    </div>

    <script>
        const API_BASE_URL = "https://skillnest-fullstack-5hws.vercel.app";

        const certMetadata = {
            html: { styleClass: "HTML", title: "HTML5", type: "Course Completion", totalVideos: 10 },
            css: { styleClass: "CSS", title: "CSS3", type: "Professional Certificate", totalVideos: 10 },
            js: { styleClass: "JavaScript", title: "JavaScript", type: "Course Completion", totalVideos: 10 },
            python: { styleClass: "Python", title: "Python", type: "Course Completion", totalVideos: 10 },
            java: { styleClass: "java", title: "Java", type: "Course Completion", totalVideos: 10 },
            react: { styleClass: "React", title: "React JS", type: "Course Completion", totalVideos: 10 },
            fastapi: { styleClass: "fastapi", title: "FastAPI", type: "Backend Specialization", totalVideos: 10 },
            db: { styleClass: "db", title: "PostgreSQL", type: "Database Expert", totalVideos: 10 }
        };

        document.addEventListener("DOMContentLoaded", init);

        async function init() {
            const user = JSON.parse(localStorage.getItem("user"));
            if (!user || !user.user_id) {
                window.location.href = "login.html";
                return;
            }
            loadCertificates(user);
        }

        async function loadCertificates(user) {
            const loading = document.getElementById("loading");
            const empty = document.getElementById("empty");
            const container = document.getElementById("certificates");

            try {
                const [courseRes, quizRes] = await Promise.all([
                    fetch(`${API_BASE_URL}/progress/course/${user.user_id}`),
                    fetch(`${API_BASE_URL}/progress/quiz/${user.user_id}`)
                ]);

                const courseProgress = await courseRes.json();
                const quizProgress = await quizRes.json();

                const unlocked = [];

                for (const key in certMetadata) {
                    const videosDone = (courseProgress[key] || []).length;
                    const quiz = quizProgress[key];

                    if (videosDone >= certMetadata[key].totalVideos && quiz?.attempts > 0) {
                        unlocked.push({
                            key,
                            ...certMetadata[key],
                            score: quiz.bestScore || 0
                        });
                    }
                }

                loading.style.display = "none";

                if (!unlocked.length) {
                    empty.style.display = "block";
                    return;
                }

                container.innerHTML = unlocked.map(cert => {
                    const baseUrl = `certificate_template.html?name=${encodeURIComponent(user.user_name)}&course=${encodeURIComponent(cert.title)}&id=SK-${user.user_id}-${cert.key.toUpperCase()}&percentage=${cert.score}`;

                    const viewUrl = baseUrl;
                    const downloadUrl = `${baseUrl}&action=download`;

                    return `
                    <div class="certificate-card">
                        <div class="certificate-preview ${cert.styleClass}">
                            <div class="certificate-badge">üèÜ</div>
                            <div class="certificate-title">${cert.title}</div>
                            <div class="certificate-type">${cert.type}</div>
                            <div class="verified-badge">‚úî Verified</div>
                        </div>

                        <div class="certificate-body">
                            <div class="certificate-id">
                                <div class="certificate-id-label">Certificate ID</div>
                                <div class="certificate-id-value">
                                    SK-${user.user_id}-${cert.key.toUpperCase()}
                                </div>
                            </div>

                            <div class="info-row">
                                <div class="info-label">Score</div>
                                <div class="info-value">${cert.score}%</div>
                            </div>

                            <div class="certificate-actions">
                                <a href="${downloadUrl}" class="action-btn btn-download" target="_blank">Download</a>
                                <a href="${viewUrl}" class="action-btn btn-view" target="_blank">View</a>
                            </div>
                        </div>
                    </div>
                    `;
                }).join("");

            } catch (err) {
                console.error(err);
                loading.textContent = "Failed to load certificates.";
            }
        }
    </script>

</body>

</html>