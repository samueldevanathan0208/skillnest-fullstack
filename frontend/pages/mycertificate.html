<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Certificates | SkillNest</title>

    <link rel="stylesheet" href="../css/mycertificate.css">
    <link rel="stylesheet" href="../css/mylearn.css">
    <link rel="stylesheet" href="../css/modals.css">

    <!-- Sidebar auto-handlers -->
    <script src="../js/sidebar-handlers.js" defer></script>
</head>

<body>

    <!-- Sidebar -->
    <aside class="sidebar">
        <nav>
            <div class="nav-section">
                <img class="logo"
                    src="../assests/Gemini_Generated_Image_awja8lawja8lawja-removebg-preview.png" alt="Logo">
                <a href="dashboard.html" class="nav-item">Dashboard</a>
                <a href="mylearn.html" class="nav-item">My Learning</a>
                <a href="mycertificate.html" class="nav-item active">Certificate</a>
            </div>

            <div class="nav-section">
                <h3 class="nav-section-title">Learn</h3>
                <a href="learingpath.html" class="nav-item">Learning Path</a>
                <a href="quizzes.html" class="nav-item">Quizzes</a>
            </div>

            <div class="nav-section">
                <h3 class="nav-section-title">Account Setting</h3>
                <a href="edit.html" class="nav-item">Edit Profile</a>
                <a href="#" id="delete-profile-link" class="nav-item">Delete Profile</a>
                <a href="#" id="sign-out-link" class="nav-item">Sign Out</a>
            </div>
        </nav>
    </aside>

    <!-- Main -->
    <div class="main-wrapper">
        <div class="header">
            <h1>My Certificates</h1>
            <p>Download your earned certificates</p>
        </div>

        <div class="container">
            <div id="loading" style="text-align:center;padding:2rem;">
                Loading certificates...
            </div>

            <div id="empty" style="display:none;text-align:center;padding:2rem;">
                <h2>No Certificates Yet</h2>
                <p>Complete all videos and quizzes to unlock certificates.</p>
                <a href="mylearn.html">Go to My Learning</a>
            </div>

            <div class="certificates-grid" id="certificates"></div>
        </div>
    </div>

    <script>
        /* ===============================
           CONFIG
        =============================== */

        const API_BASE_URL = "https://skillnest-fullstack-5hws.vercel.app";

        const certMetadata = {
            html: {
                title: 'HTML5',
                instructor: 'John Smith',
                type: 'Course Completion',
                totalVideos: 10
            },
            css: {
                title: 'CSS3',
                instructor: 'Mike Wilson',
                type: 'Professional Certificate',
                totalVideos: 10
            },
            js: {
                title: 'JavaScript',
                instructor: 'Emily Brown',
                type: 'Course Completion',
                totalVideos: 10
            },
            python: {
                title: 'Python',
                instructor: 'Sarah Johnson',
                type: 'Course Completion',
                totalVideos: 10
            },
            java: {
                title: 'Java',
                instructor: 'David Chen',
                type: 'Course Completion',
                totalVideos: 10
            },
            react: {
                title: 'React JS',
                instructor: 'Alex Turner',
                type: 'Course Completion',
                totalVideos: 10
            },
            fastapi: {
                title: 'FastAPI',
                instructor: 'Maria Garcia',
                type: 'Backend Specialization',
                totalVideos: 10
            },
            db: {
                title: 'PostgreSQL',
                instructor: 'Robert Taylor',
                type: 'Database Expert',
                totalVideos: 10
            }
        };

        /* ===============================
           INIT
        =============================== */

        document.addEventListener("DOMContentLoaded", init);

        async function init() {
            const user = JSON.parse(localStorage.getItem("user"));
            if (!user || !user.user_id) {
                window.location.href = "login.html";
                return;
            }
            loadCertificates(user);
        }

        /* ===============================
           LOAD CERTIFICATES
        =============================== */

        async function loadCertificates(user) {
            const loading = document.getElementById("loading");
            const empty = document.getElementById("empty");
            const container = document.getElementById("certificates");

            try {
                const [courseRes, quizRes] = await Promise.all([
                    fetch(`${API_BASE_URL}/progress/course/${user.user_id}`),
                    fetch(`${API_BASE_URL}/progress/quiz/${user.user_id}`)
                ]);

                if (!courseRes.ok || !quizRes.ok) {
                    throw new Error("Progress API failed");
                }

                const courseProgress = await courseRes.json();
                const quizProgress = await quizRes.json();

                const unlocked = [];

                for (const key in certMetadata) {
                    const videosDone = (courseProgress[key] || []).length;
                    const quiz = quizProgress[key];

                    if (
                        videosDone >= certMetadata[key].totalVideos &&
                        quiz &&
                        quiz.attempts > 0
                    ) {
                        unlocked.push({
                            id: key,
                            ...certMetadata[key],
                            score: quiz.bestScore || 0
                        });
                    }
                }

                loading.style.display = "none";

                if (unlocked.length === 0) {
                    empty.style.display = "block";
                    return;
                }

                container.innerHTML = unlocked.map(cert => `
                    <div class="certificate-card">
                        <h3>${cert.title}</h3>
                        <p><strong>Instructor:</strong> ${cert.instructor}</p>
                        <p><strong>Type:</strong> ${cert.type}</p>
                        <p><strong>Score:</strong> ${cert.score}</p>
                        <a class="btn"
                           href="certificate_template.html?name=${encodeURIComponent(user.user_name)}&course=${encodeURIComponent(cert.title)}">
                           View Certificate
                        </a>
                    </div>
                `).join("");

            } catch (err) {
                console.error(err);
                loading.textContent = "Failed to load certificates.";
            }
        }
    </script>

</body>

</html>
